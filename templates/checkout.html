{% extends 'base.html' %}
{% block content %}
<section class="checkout-section" style="padding: 40px 20px; background: #f8f9fa;">
    <div class="container" style="max-width: 900px; margin: auto;">

        <h1 class="section-title" style="margin-bottom: 25px; text-align: center;">Checkout</h1>

        {% if products %}

        <!-- Detail User -->
        <div style="margin-bottom: 25px; padding: 20px; background: #fff; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
            <h2 style="margin-bottom: 12px; font-size: 1.3rem;">Detail Pengiriman</h2>
            <p><strong>Nama:</strong> {{ user.name }}</p>
            <p><strong>Nomor Telepon:</strong> {{ user.no_telepon }}</p>
            <p><strong>Alamat Lengkap:</strong> {{ user.alamat }},
                RT {{ user.rt }}/RW {{ user.rw }},
                Kel. {{ user.kelurahan }}, Kec. {{ user.kecamatan }},
                {{ user.kota }}, {{ user.provinsi }},
                Kode Pos {{ user.kode_pos }}
            </p>
        </div>

        <!-- Produk List -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
            {% for item in products %}
            <div style="background: #fff; border-radius: 12px; padding: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); text-align: center;">
                <img src="{{ url_for('static', filename='uploads/' + item.product.image) if item.product.image else 'https://via.placeholder.com/120' }}" 
                     alt="{{ item.product.name }}" style="width: 100%; height: 160px; object-fit: cover; border-radius: 10px; margin-bottom: 10px;">
                <h3 style="font-size: 1rem; margin: 5px 0;">{{ item.product.name }}</h3>
                <p style="margin: 3px 0;">Rp {{ "{:,.0f}".format(item.product.price) }}</p>
                <p style="margin: 3px 0;">Jumlah: {{ item.qty }}</p>
                <p style="margin: 5px 0; font-weight: bold;">Subtotal: Rp {{ "{:,.0f}".format(item.subtotal) }}</p>
            </div>
            {% endfor %}
        </div>

        <!-- Total & Pengiriman -->
        <div style="background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-bottom: 25px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <span style="font-size: 1.2rem; font-weight: 600;">Total</span>
                <span style="font-size: 1.3rem; font-weight: 700; color: #28a745;">Rp {{ "{:,.0f}".format(total) }}</span>
            </div>

            <div style="margin-top: 10px;">
                <label for="shipping_method" style="font-weight: 600;">Jasa Pengiriman:</label>
                <select name="shipping_method" id="shipping_method" required style="width: 100%; padding: 10px; margin-top: 8px; border-radius: 8px; border: 1px solid #ddd;">
                    <option value="">-- Pilih Jasa Pengiriman --</option>
                    {% for ship in shipping_methods %}
                    <option value="{{ ship }}">{{ ship }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Tombol Bayar -->
        <form id="payment-form" method="POST">
            <button type="button" id="pay-button" class="btn btn-success" 
                    style="width: 100%; padding: 14px 0; font-size: 1.1rem; font-weight: 600; border-radius: 12px;">
                Bayar Sekarang
            </button>
        </form>

        <!-- Midtrans Snap -->
        <script type="text/javascript"
            src="https://app.sandbox.midtrans.com/snap/snap.js"
            data-client-key="{{ client_key }}"></script>
        <script type="text/javascript">
            var payButton = document.getElementById('pay-button');
            payButton.addEventListener('click', function () {
                var shippingMethod = document.getElementById('shipping_method').value;
                if (!shippingMethod) {
                    alert("Pilih jasa pengiriman dulu!");
                    return;
                }
                snap.pay("{{ snap_token }}", {
                    onSuccess: function(result){
                        window.location.href = "{{ url_for('payment_success', order_id=order_id) }}";
                    },
                    onPending: function(result){
                        window.location.href = "{{ url_for('payment_pending', order_id=order_id) }}";
                    },
                    onError: function(result){
                        alert("Pembayaran gagal: " + result.status_message);
                    },
                    onClose: function(){
                        alert('Anda menutup popup pembayaran.');
                    }
                });
            });
        </script>

        {% else %}
        <p style="text-align: center; font-size: 1.2rem;">Keranjang kosong. <a href="{{ url_for('index') }}">Kembali ke produk</a></p>
        {% endif %}
    </div>
</section>
{% endblock %}
